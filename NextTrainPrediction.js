// This is code for the scriptable iOS app.
// You can call it from a shortcut by opening URL 
// scriptable:///run?scriptname=NextTrain&station=E6
// note the arguments
// arg station is the station identifier (use GPS if missing)
// arg format specify "r" for relative time, default is absolute
// arg output specify "n" for notification, default is spoken
//
// todo
//   Convert absolute outputs from directional to destination (arrivalsa obj created)
//   Import schedule for end of line cases and ghost trains

var rq = new Request("http://labs.itsmarta.com/signpost/predictions");
var mylocation = await Location.current();// 
var prediction = await rq.loadJSON();
var speak = "";
var west, east, north, south, arrival, dest;
var arrivalsr = {};
var arrivalsa = {};
west = new Date("1/1/2200"); 
east = new Date("1/1/2200"); 
south = new Date("1/1/2200"); 
north = new Date("1/1/2200");

var stations = {
  "E1": {
        "StationAbbreviation": "E1", 
        "StationName": " Georgia State ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Georgia-State.aspx",
        "StationAddress": "170 Piedmont Ave, SE, Atlanta, GA 30303", 
        "StationCrossStreets": "Piedmont Avenue near Decatur Street", 
        "StationGPS": "33.75018633457871, -84.38618046938421"
  },
  "E2": {
        "StationAbbreviation": "E2", 
        "StationName": " King Memorial ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/King-Memorial.aspx",
        "StationAddress": "377 Decatur St, SE, Atlanta, GA 30312", 
        "StationCrossStreets": "Decatur at Grant Street", 
        "StationGPS": "33.749923784168054, -84.37557557211754"
  },
  "E3": {
        "StationAbbreviation": "E3", 
        "StationName": " Inman Park / Reynoldstown ",
        "StationPronunciation": "Inman Park / Reynolds Town", 
        "StationURL": "https://itsmarta.com/Inman-Park.aspx",
        "StationAddress": "1055 DeKalb Ave, NE, Atlanta, GA 30307", 
        "StationCrossStreets": "DeKalb Avenue at Hurt Street", 
        "StationGPS": "33.75767338612786, -84.35254451436396"
  },
  "E4":{
        "StationAbbreviation": "E4", 
        "StationName": " Edgewood / Candler Park ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Edgewood-Candler-Park.aspx",
        "StationAddress": "1475 DeKalb Ave, NE, Atlanta, GA 30307", 
        "StationCrossStreets": "DeKalb Avenue at Oakdale Road", 
        "StationGPS": "33.76191878812466, -84.33963930099395"
  },
  "E5": {
        "StationAbbreviation": "E5", 
        "StationName": " East Lake ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/East-Lake.aspx",
        "StationAddress": "2260 College Ave, Atlanta, GA 30307", 
        "StationCrossStreets": "College Avenue and East Lake Road", 
        "StationGPS": "33.765148350874895, -84.31295850153049"
  },
  "E6": {
        "StationAbbreviation": "E6", 
        "StationName": " Decatur ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Decatur.aspx",
        "StationAddress": "400 Church St, Decatur, GA 30030", 
        "StationCrossStreets": "Church Street and Sycamore Street", 
        "StationGPS": "33.77462519237718,-84.29615194824973"
  },
  "E7": {
        "StationAbbreviation": "E7", 
        "StationName": " Avondale ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Avondale.aspx",
        "StationAddress": "915 E Ponce de Leon Ave, Decatur, GA 30030", 
        "StationCrossStreets": "East Ponce De Leon Avenue near North Arcadia", 
        "StationGPS": "33.775100373911734, -84.28226687238848"
  },
  "E8": {
        "StationAbbreviation": "E8", 
        "StationName": " Kensington ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Kensington.aspx",
        "StationAddress": "3350 Kensington Rd, Decatur, GA 30032", 
        "StationCrossStreets": "Kensington at Memorial Drive", 
        "StationGPS": "33.77266478073744, -84.25148898193302"
  },
  "E9": {
        "StationAbbreviation": "E9", 
        "StationName": " Indian Creek ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Indian-Creek.aspx",
        "StationAddress": "3901 Durham Park Rd, Stone Mountain, GA 30083", 
        "StationCrossStreets": "Durham Road at I-285", 
        "StationGPS": "33.76976549057783, -84.22967580099167"
  },
  "W0": {
        "StationAbbreviation": "W0", 
        "StationName": " Five Points ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Five-Points.aspx",
        "StationAddress": "30 Alabama St SW, Atlanta, GA 30303", 
        "StationCrossStreets": "Alabama at Peachtree Street", 
        "StationGPS": "33.75392023598456,-84.39162662288796"
  },
  "W1": {
        "StationAbbreviation": "W1", 
        "StationName": " Dome / G W C C / Philips / C N N ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Omni.aspx",
        "StationAddress": "100 Centennial Olympic Park Dr NW, Atlanta, GA 30303", 
        "StationCrossStreets": "Centennial Olympic Park Dr NW near State Farm Arena", 
        "StationGPS": "33.756520946164684, -84.39677637265507"
  },
  "W2": {
        "StationAbbreviation": "W2", 
        "StationName": " Vine City ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Vine-City.aspx",
        "StationAddress": "502 Rhodes St, NW, Atlanta, GA 30314", 
        "StationCrossStreets": "Rhodes Street near Northside Drive", 
        "StationGPS": "33.7565195661912, -84.40397417238654"
  },
  "W3": {
        "StationAbbreviation": "W3", 
        "StationName": " Ashby ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Ashby.aspx",
        "StationAddress": "65 Joseph E Lowery Blvd, Atlanta, GA 30314", 
        "StationCrossStreets": "Joseph E. Lowery at Carter Street", 
        "StationGPS": "33.75624413068095, -84.41690619533414"
  },
  "W4": {
        "StationAbbreviation": "W4", 
        "StationName": " West Lake ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/West-Lake.aspx",
        "StationAddress": "80 Anderson Ave, SW, Atlanta, GA 30314", 
        "StationCrossStreets": "Anderson Avenue at West Lake Avenue at M. L. King Jr. Drive", 
        "StationGPS": "33.75319504495991, -84.44524029802737"
  },
  "W5": {
        "StationAbbreviation": "W5", 
        "StationName": " Hamilton E Holmes ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Hamilton-E-Holmes.aspx",
        "StationAddress": "70 Hamilton E Holmes Dr, NW, Atlanta, GA 30311", 
        "StationCrossStreets": "H. E. Holmes Drive at M. L. King Jr. Drive", 
        "StationGPS": "33.75438366530488, -84.47035377238693"
  },
  "P4": {
        "StationAbbreviation": "P4", 
        "StationName": " Bankhead ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Bankhead.aspx",
        "StationAddress": "1335 Donald Hollowell Pkwy, Atlanta, GA 30318", 
        "StationCrossStreets": "Bankhead Hwy near Marietta Boulevard", 
        "StationGPS": "33.77225494494861, -84.42886489802665"
  },
  "S1": {
        "StationAbbreviation": "S1", 
        "StationName": " Garnett ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Garnett.aspx",
        "StationAddress": "225 Peachtree St, SW, Atlanta, GA 30303", 
        "StationCrossStreets": "Brotherton Street at Peachtree Street", 
        "StationGPS": "33.7484910142787, -84.39594632329779"
  },
  "S2": {
        "StationAbbreviation": "S2", 
        "StationName": " West End ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/West-End.aspx",
        "StationAddress": "680 Lee St, SW, Atlanta, GA 30310", 
        "StationCrossStreets": "Lee Street at Oglethorpe", 
        "StationGPS": "33.736036619930154, -84.41367813817436"
  },
  "S3": {
        "StationAbbreviation": "S3", 
        "StationName": " Oakland City ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Oakland-City.aspx",
        "StationAddress": "1400 Lee St, SW, Atlanta, GA 30310", 
        "StationCrossStreets": "Lee Street at Arden Avenue", 
        "StationGPS": "33.71692936002462, -84.42512787331452"
  },
  "S4": {
        "StationAbbreviation": "S4", 
        "StationName": " Lakewood / Fort McPherson ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Lakewood.aspx",
        "StationAddress": "2020 Lee St, SW, Atlanta, GA 30310", 
        "StationCrossStreets": "Lee Street at Lakewood Avenue", 
        "StationGPS": "33.7005387953148, -84.42951615848011"
  },
  "S5": {
        "StationAbbreviation": "S5", 
        "StationName": " East Point ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/East-Point.aspx",
        "StationAddress": "2848 East Main St, East Point, GA 30344", 
        "StationCrossStreets": "East Main Street at Washington Road", 
        "StationGPS": "33.67755787021818, -84.4405312672711"
  },
  "S6": {
        "StationAbbreviation": "S6", 
        "StationName": " College Park ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/College-Park.aspx",
        "StationAddress": "3800 Main St, Atlanta, GA 30337", 
        "StationCrossStreets": "East Main Street at Howard Avenue", 
        "StationGPS": "33.65166248476533, -84.44880100072415"
  },
  "S7": {
        "StationAbbreviation": "S7", 
        "StationName": " Airport ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Airport.aspx",
        "StationAddress": "6000 S Terminal Pkwy, Atlanta, GA 30337", 
        "StationCrossStreets": "ATL", 
        "StationGPS": "33.64080453587645,-84.44624731278977"
  },
  "N1": {
        "StationAbbreviation": "N1", 
        "StationName": " Peachtree Center ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Peachtree-Center.aspx",
        "StationAddress": "216 Peachtree St, NE, Atlanta, GA 30303", 
        "StationCrossStreets": "Peachtree Street at Andrew Young Boulevard", 
        "StationGPS": "33.75797266886301, -84.3878131023025"
  },
  "N2": {
        "StationAbbreviation": "N2", 
        "StationName": " Civic Center ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Civic-Center.aspx",
        "StationAddress": "435 West Peachtree St, NW, Atlanta, GA 30308", 
        "StationCrossStreets": "West Peachtree Street at Pine Street", 
        "StationGPS": "33.766569789581915, -84.38761890099283"
  },
  "N3": {
        "StationAbbreviation": "N3", 
        "StationName": " North Avenue ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/North-Ave.aspx",
        "StationAddress": "713 West Peachtree St, NW, Atlanta, GA 30308", 
        "StationCrossStreets": "Intersection of West Peachtree Street and North Avenue", 
        "StationGPS": "33.77168350939747, -84.38702857184813"
  },
  "N4": {
        "StationAbbreviation": "N4", 
        "StationName": " Midtown ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Midtown.aspx",
        "StationAddress": "41 Tenth St, NE, Atlanta, GA 30309", 
        "StationCrossStreets": "10th Street near West Peachtree Street", 
        "StationGPS": "33.7811144283705, -84.38631161382303"
  },
  "N5": {
        "StationAbbreviation": "N5", 
        "StationName": " Arts Center ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Arts-Center.aspx",
        "StationAddress": "1255 West Peachtree St, Atlanta, GA 30309", 
        "StationCrossStreets": "West Peachtree Street at 15th street", 
        "StationGPS": "33.78923625608165, -84.38727702887373"
  },
  "N6": {
        "StationAbbreviation": "N6", 
        "StationName": " Lindbergh Center ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Lindbergh.aspx",
        "StationAddress": "2424 Piedmont Rd, NE, Atlanta, GA 30324", 
        "StationCrossStreets": "Piedmont Road at Lindbergh Drive", 
        "StationGPS": "33.823106342847396, -84.36944144668193"
  },
  "N7": {
        "StationAbbreviation": "N7", 
        "StationName": " Buckhead ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Buckhead.aspx",
        "StationAddress": "3360 Peachtree Rd, NE, Atlanta, GA 30326", 
        "StationCrossStreets": "Peachtree Road at GA 400", 
        "StationGPS": "33.848799445796175, -84.36836033830365"
  },
  "N8": {
        "StationAbbreviation": "N8", 
        "StationName": " Medical Center ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Medical-Center.aspx",
        "StationAddress": "5711 Peachtree-Dunwoody Rd, NE, Atlanta, GA 30342", 
        "StationCrossStreets": "Peachtree Dunwoody at Lake Hearn Drive", 
        "StationGPS": "33.91066582663132, -84.3515712015336"
  },
  "N9": {
        "StationAbbreviation": "N9", 
        "StationName": " Dunwoody ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Dunwoody.aspx",
        "StationAddress": "1118 Hammond Dr, Atlanta, GA 30328", 
        "StationCrossStreets": "Hammond Drive at Perimeter Center Parkway", 
        "StationGPS": "33.921257306833674, -84.34442045253438"
  },
  "N10":{
        "StationAbbreviation": "N10", 
        "StationName": " Sandy Springs ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Sandy-Springs.aspx",
        "StationAddress": "1101 Mount Vernon Hwy, Atlanta, GA 30338", 
        "StationCrossStreets": "Abernathy Road / Perimeter Center West & Mt. Vernon Hwy", 
        "StationGPS": "33.93190113490794, -84.3506936886832"
  },
  "N11":{
        "StationAbbreviation": "N11", 
        "StationName": " North Springs ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/North-Springs.aspx",
        "StationAddress": "7010 Peachtree Dunwoody Rd, Sandy Springs, GA 30328", 
        "StationCrossStreets": "East of GA 400 and west of Peachtree Dunwoody Road", 
        "StationGPS": "33.94502750398834, -84.35712289988743"
  },
  "NE7": {
        "StationAbbreviation": "NE7", 
        "StationName": " Lenox ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Lenox.aspx",
        "StationAddress": "955 East Paces Ferry Rd, NE, Atlanta, GA 30326", 
        "StationCrossStreets": "East Paces Ferry Road at Lenox Road", 
        "StationGPS": "33.84505206993194, -84.35862848657872"
  },
  "NE8": {
        "StationAbbreviation": "NE8", 
        "StationName": " Brookhaven / Oglethorpe ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Brookhaven.aspx",
        "StationAddress": "4047 Peachtree Road, NE, Atlanta, GA 30319", 
        "StationCrossStreets": "Peachtree Road at Dresden Drive", 
        "StationGPS": "33.859975208994115, -84.33933304351426"
  },
  "NE9": {
        "StationAbbreviation": "NE9", 
        "StationName": " Chamblee ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Chamblee.aspx",
        "StationAddress": "5200 New Peachtree Road, Chamblee, GA 30341", 
        "StationCrossStreets": "Peachtree Road at Chamblee-Tucker Road", 
        "StationGPS": "33.88671281400198, -84.30757243995006"
  },
  "NE10":{
        "StationAbbreviation": "NE10", 
        "StationName": " Doraville ",
        "StationPronunciation": "", 
        "StationURL": "https://itsmarta.com/Doraville.aspx",
        "StationAddress": "6000 New Peachtree Rd, Doraville, GA 30340", 
        "StationCrossStreets": "New Peachtree Road at Central Avenue", 
        "StationGPS": "33.90291031759458, -84.2801348729308"
  }
}

if (args.queryParameters.station){
  var station=args.queryParameters.station;
  var stationName = stations[station].StationName;
} else {
  var closest="";
  var shortest=9999;
  for (station in stations) {
    if (stations[station].StationGPS != "") {
      var mycoords = stations[station].StationGPS.split(",",2);
      var mydist = getDistanceFromLatLonInKm(mylocation.latitude,mylocation.longitude,mycoords[0],mycoords[1]);
      if (mydist < shortest) {
        shortest = mydist;
        closest = station;
      }
    }
  }
  station = closest;
  var stationName = stations[station].StationName;
}
if (args.queryParameters.format){
  var format=args.queryParameters.format;
}
if (args.queryParameters.output){
  var outputtype=args.queryParameters.output;
}
let i = 0;
while (i < prediction.length) {
  if (prediction[i].station.indexOf(station) == 0){
    dest = prediction[i].destination;
    if (typeof arrivalsr.dest === 'undefined') {
      arrivalsr[dest] = prediction[i].seconds;
      arrivalsa[dest] = new Date(prediction[i].nextArr);
    } else if (prediction[i].seconds < arrivalsr.dest) {
      arrivalsr[dest] = prediction[i].seconds;
      arrivalsa[dest] = new Date(prediction[i].nextArr);
    }
    if (prediction[i].direction.indexOf("E")>-1){
      arrival = new Date(prediction[i].nextArr);
      if (arrival < east) {
        east = arrival;
      }
    }
    if (prediction[i].direction.indexOf("W")>-1){
      arrival = new Date(prediction[i].nextArr);
      if (arrival < west) {
        west = arrival;
      }
    }
    if (prediction[i].direction.indexOf("S")>-1){
      arrival = new Date(prediction[i].nextArr);
      if (arrival < south) {
        south = arrival;
      }
    }
    if (prediction[i].direction.indexOf("N")>-1){
      arrival = new Date(prediction[i].nextArr);
      if (arrival < north) {
        north = arrival;
      }
    }
  }
  i++;
}
log(arrivalsr);
if (south < new Date("1/1/2200")) { 
  speak = speak + " A Southbound train arrives in Decatur at "; 
  if (south.getHours()>12) {
    speak = speak + (south.getHours()-12);
  }
  else {
    speak = speak + south.getHours();
  }
  if (south.getMinutes()<10){
    speak = speak + " O " + south.getMinutes();
  }
  else {
    speak = speak + " " + south.getMinutes();
  }
  if (south.getHours()>11) {
    speak = speak + " pm";
  }
  else {
    speak = speak + " am";
  }
  speak = speak + ".";
}
if (north < new Date("1/1/2200")) { 
  speak = speak + " A Northbound train arrives in Decatur at "; 
  if (north.getHours()>12) {
    speak = speak + (north.getHours()-12);
  }
  else {
    speak = speak + north.getHours();
  }
  if (north.getMinutes()<10){
    speak = speak + " O " + north.getMinutes();
  }
  else {
    speak = speak + " " + north.getMinutes();
  }
  if (north.getHours()>11) {
    speak = speak + " pm";
  }
  else {
    speak = speak + " am";
  }
  speak = speak + ".";
}
if (east < new Date("1/1/2200")) { 
  speak = speak + " An Eastbound train arrives in Decatur at "; 
  if (east.getHours()>12) {
    speak = speak + (east.getHours()-12);
  }
  else {
    speak = speak + east.getHours();
  }
  if (east.getMinutes()<10){
    speak = speak + " O " + east.getMinutes();
  }
  else {
    speak = speak + " " + east.getMinutes();
  }
  if (east.getHours()>11) {
    speak = speak + " pm";
  }
  else {
    speak = speak + " am";
  }
  speak = speak + ".";
}
if (west < new Date("1/1/2200")) { 
  speak = speak + " A Westbound train arrives in Decatur at "; 
  if (west.getHours()>12) {
    speak = speak + (west.getHours()-12);
  }
  else {
    speak = speak + west.getHours();
  }
  if (west.getMinutes()<10){
    speak = speak + " O " + west.getMinutes();
  }
  else {
    speak = speak + " " + west.getMinutes();
  }
  if (west.getHours()>11) {
    speak = speak + " pm";
  }
  else {
    speak = speak + " am";
  }
  speak = speak + ".";
}
if (format == "r") {
  speak = "";
  var count = 0;
  for(var prop in arrivalsr) {
    if(arrivalsr.hasOwnProperty(prop))
      ++count;
  }
  if (count > 0) {
    speak += "For" + stationName + "Station: ";
    for (const key in arrivalsr) {
      var mins = Math.round(arrivalsr[key]/60)
      speak += "The next train to "+ key + " arrives in " + mins + " minute";
      if (mins != 1) {
        speak += "s";
      }
      speak += ". ";
    }
  } else {
    speak = "No arrival data for " + stationName + " Station."
  }
}

if (outputtype == "n") {
  n = new Notification();
  n.title = "Next train";
  n.body = speak;
  n.schedule();
} else {
  speak = encodeURI(speak);
  Safari.open("shortcuts://x-callback-url/run-shortcut?name=SpeakScript&input="+speak);
}

function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
  var R = 6371; // Radius of the earth in km
  var dLat = deg2rad(lat2-lat1);  // deg2rad below
  var dLon = deg2rad(lon2-lon1); 
  var a = 
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
    Math.sin(dLon/2) * Math.sin(dLon/2)
    ; 
  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
  var d = R * c; // Distance in km
  return d;
}

function deg2rad(deg) {
  return deg * (Math.PI/180)
}
